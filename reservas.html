<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Reservas - Restaurante</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
  <h2 class="text-center">Mis Reservas</h2>
  <button class="btn btn-danger" id="logout">Cerrar sesión</button>
  <div id="reservas-list" class="mt-4"></div>

  <h3 class="mt-5">Nueva Reserva</h3>
  <form id="reservaForm">
    <div class="mb-3">
      <label for="fecha" class="form-label">Fecha</label>
      <input type="date" class="form-control" id="fecha" required>
    </div>
    <div class="mb-3">
      <label for="hora" class="form-label">Hora</label>
      <select class="form-control" id="hora" required>
        <option value="14:00">14:00</option>
        <option value="21:00">21:00</option>
      </select>
    </div>
    <button type="button" class="btn btn-primary" id="buscarMesas">Buscar Mesas</button>
  </form>

  <div id="mesas-disponibles" class="mt-4">
    <select id="mesaSelect" class="form-control d-none">
      <option value="">Selecciona una mesa</option>
    </select>

    <!-- Nuevo input para el número de personas -->
    <input type="number" id="numPersonas" class="form-control mt-2 d-none" placeholder="Número de personas" min="1">

    <button id="reservarBtn" class="btn btn-success mt-2 d-none">Reservar</button>
  </div>




</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function() {
    if (!localStorage.getItem("token")) {
      window.location.href = "index.html";
    }

    const fechaInput = document.getElementById("fecha");
    const hoy = new Date().toISOString().split("T")[0];
    fechaInput.setAttribute("min", hoy);

    function cargarReservas() {
      fetch("http://localhost:8080/reservas/mis-reservas", {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
      })
              .then(response => response.json())
              .then(reservas => {
                let html = "<ul class='list-group'>";
                reservas.forEach(reserva => {
                  html += `<li class='list-group-item'>${reserva.fecha} - Mesa ${reserva.mesa.id}
        <button class='btn btn-danger btn-sm float-end' onclick='borrarReserva(${reserva.id})'>Eliminar</button>
      </li>`;
                });
                html += "</ul>";
                document.getElementById("reservas-list").innerHTML = html;
              })
              .catch(error => console.error("Error cargando reservas:", error));
    }



    document.getElementById("buscarMesas").addEventListener("click", function() {
      const fechaInput = document.getElementById("fecha");
      const fecha = fechaInput.value;
      const hora = document.getElementById("hora").value;

      if (!fecha || !hora) {
        alert("Por favor, selecciona fecha y hora");
        return;
      }

      const fechaHora = `${fecha}T${hora}:00`;

      fetch(`http://localhost:8080/mesas/disponibles?fecha=${fechaHora}&hora=${hora}`, {
        headers: {
          "Authorization": `Bearer ${localStorage.getItem("token")}`
        }
      })
              .then(response => {
                if (!response.ok) {
                  return response.text().then(text => { throw new Error(text); });
                }
                return response.json();
              })
              .then(mesas => {
                if (!Array.isArray(mesas)) {
                  throw new Error("Respuesta no es un array");
                }

                const mesaSelect = document.getElementById("mesaSelect");
                const reservarBtn = document.getElementById("reservarBtn");
                const numPersonasInput = document.getElementById("numPersonas");

                mesaSelect.innerHTML = "<option value=''>Selecciona una mesa</option>";

                mesas.forEach(mesa => {
                  const option = document.createElement("option");
                  option.value = mesa.id;
                  option.textContent = `${mesa.numeroMesa} - ${mesa.descripcion || 'Sin descripción'}`;
                  mesaSelect.appendChild(option);
                });

                mesaSelect.classList.remove("d-none");
                numPersonasInput.classList.remove("d-none");
                reservarBtn.classList.remove("d-none");

                // Guardamos la fecha y hora seleccionadas en atributos del botón de reservar
                reservarBtn.dataset.fecha = fecha;
                reservarBtn.dataset.hora = hora;
              })
              .catch(error => console.error("Error obteniendo mesas:", error));
    });

    document.getElementById("reservarBtn").addEventListener("click", function() {
      const mesaId = document.getElementById("mesaSelect").value;
      const numPersonas = document.getElementById("numPersonas").value;

      if (!mesaId) {
        alert("Por favor, selecciona una mesa.");
        return;
      }
      if (!numPersonas || numPersonas <= 0) {
        alert("Por favor, introduce un número válido de personas.");
        return;
      }

      const fecha = this.dataset.fecha;
      const hora = this.dataset.hora;
      const fechaHora = `${fecha}T${hora}:00`;

      fetch("http://localhost:8080/reservas", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${localStorage.getItem("token")}`
        },
        body: JSON.stringify({
          mesa: { id: mesaId },
          fecha: fechaHora,
          numeroPersonas: numPersonas
        })
      })
              .then(response => {
                if (!response.ok) throw new Error("Error en la reserva");
                return response.json();
              })
              .then(() => {
                alert("Reserva realizada con éxito");
                document.getElementById("mesaSelect").classList.add("d-none");
                document.getElementById("numPersonas").classList.add("d-none");
                document.getElementById("reservarBtn").classList.add("d-none");
                cargarReservas();
              })
              .catch(error => console.error("Error realizando la reserva:", error));
    });




    window.borrarReserva = function(id) {
      fetch(`http://localhost:8080/reservas/${id}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
      })
              .then(response => {
                if (!response.ok) throw new Error("No tienes permiso para borrar esta reserva");
                return response.text();
              })
              .then(() => {
                alert("Reserva eliminada");
                cargarReservas();
              })
              .catch(error => console.error("Error eliminando reserva:", error));
    }

    document.getElementById("logout").addEventListener("click", function() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    });

    cargarReservas();
  });
</script>
</body>
</html>
